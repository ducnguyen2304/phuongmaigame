<!DOCTYPE html>
<html>
<head>
<title>FUV Game</title>
<style>
* { margin: 0; padding: 0; overflow: hidden; }
body { background: #000; }
canvas { display: block; pointer-events: none; }
#coords { position: fixed; top: 10px; left: 10px; color: white; font-family: monospace; font-size: 16px; background: rgba(0,0,0,0.5); padding: 5px 10px; pointer-events: none; }
#musicBtn, #feedbackBtn { position: fixed; bottom: 20px; left: 20px; padding: 10px 15px; background: rgba(0,0,0,0.7); color: white; border: 2px solid white; border-radius: 5px; cursor: pointer; font-size: 14px; z-index: 1000; transition: background 0.3s; pointer-events: auto; }
#musicBtn:hover, #feedbackBtn:hover { background: rgba(255,255,255,0.2); }
#musicBtn { bottom: 70px; }
#feedbackBtn { bottom: 20px; }
</style>
</head>
<body>
<div id="coords">X: 0, Y: 0</div>
<button id="musicBtn">üîä Music ON</button>
<button id="feedbackBtn">üìù Feedback Form</button>
<canvas id="common_area"></canvas>
<script>
const canvas = document.getElementById('common_area');
const ctx = canvas.getContext('2d');
const coords = document.getElementById('coords');
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;
window.addEventListener('resize', () => {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
});

// Image and asset loading
const bg = new Image();
const char = new Image();

let assetsLoaded = 0;
function checkStart() {
  assetsLoaded++;
  if (assetsLoaded === 2) {
    loop(); // start game only after bg + char both loaded
  }
}

bg.onload = checkStart;
char.onload = checkStart;

bg.src = '/background/common_area.png';
char.src = '/character/char.png';

// Player and input 
const player = { x: 700, y: 600, w: 100, h: 150, speed: 6 };
const keys = {};

// Obstacles
const table = { x: 1080, y: 430, w: 160, h: 100 };
const tree = { x: 670, y: 220, w: 100, h: 222 };
const piano = { x: 0, y: 520, w: 230, h: 90 };

// checkpoint area (table)
const checkpoint = { 
  x: 1080, y: 430, w: 160, h: 100,
  triggerDistance: 150 
};
let nearCheckpoint = false;

// Newsletter checkpoint
const newsletter = { x: 832, y: 691, triggerDistance: 100 };
let nearNewsletter = false;
let newsletterOpen = false;

// Preload newsletter image
const newsletterImg = new Image();
newsletterImg.src = '/asset/newsletter_c1.png';

// Music 
const bgMusic = new Audio('/sound/bellrock.mp3');
bgMusic.loop = true;
bgMusic.volume = 0.5;
let isMusicEnabled = true;

// Start / retry music when player actually uses controls
document.addEventListener(
  'keydown',
  (e) => {
    // Only treat control keys as valid gestures
    if (!['w', 'a', 's', 'd', 'e', 'c', 'm'].includes(e.key)) return;

    if (bgMusic.paused && isMusicEnabled) {
      bgMusic.play().catch(err => {
        console.log('bgMusic play blocked:', err);
      });
    }
  },
  { capture: true }
);

// Music toggle button functionality
const musicBtn = document.getElementById('musicBtn');
musicBtn.addEventListener('click', () => {
  isMusicEnabled = !isMusicEnabled;
  if (isMusicEnabled) {
    bgMusic.play().catch(() => {});
    musicBtn.textContent = 'üîä Music ON';
  } else {
    bgMusic.pause();
    musicBtn.textContent = 'üîá Music OFF';
  }
});

// Feedback button functionality
const feedbackBtn = document.getElementById('feedbackBtn');
feedbackBtn.addEventListener('click', () => {
  window.open('https://docs.google.com/forms/d/e/1FAIpQLSflYPOSMXIHMsTg1yjtbUCtOVNrtUJV9_OQYcvg6fLb85r2NA/viewform', '_blank');
});

// Collision 
function collides(px, py) {
  // Block y < 80
  if (py < 80) return true;
  
  // Table collision
  if (px + player.w > table.x && px < table.x + table.w &&
      py + player.h > table.y && py < table.y + table.h) return true;
  
  // Tree collision
  if (px + player.w > tree.x && px < tree.x + tree.w &&
      py + player.h > tree.y && py < tree.y + tree.h) return true;

  // Piano collision
  if (px + player.w > piano.x && px < piano.x + piano.w &&
      py + player.h > piano.y && py < piano.y + piano.h) return true;

  return false;
}

// Check if near checkpoint
function checkCheckpoint() {
  const playerCenterX = player.x + player.w / 2;
  const playerCenterY = player.y + player.h / 2;
  const tableCenterX = checkpoint.x + checkpoint.w / 2;
  const tableCenterY = checkpoint.y + checkpoint.h / 2;
  
  const distance = Math.hypot(playerCenterX - tableCenterX, playerCenterY - tableCenterY);
  nearCheckpoint = distance < checkpoint.triggerDistance;

  // Check newsletter proximity
  const newsletterDist = Math.hypot(playerCenterX - newsletter.x, playerCenterY - newsletter.y);
  nearNewsletter = newsletterDist < newsletter.triggerDistance;
}

// Input handling 
document.addEventListener('keydown', e => {
  // Block arrow keys from scrolling / doing anything
  if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.key)) {
    e.preventDefault();
    return;
  }
  keys[e.key] = true;
});

document.addEventListener('keyup', e => {
  keys[e.key] = false;
});

// Navigation and interaction
document.addEventListener('keydown', e => {
  if (e.key === 'c' && nearCheckpoint) {
    window.location.href = 'classroom1.html';  // Navigate to classroom1
  }
  if (e.key === 'm' && nearCheckpoint) {
    window.location.href = 'mks.html';  // Navigate to mks
  }
  if (e.key === 'e' && nearNewsletter) {
    newsletterOpen = !newsletterOpen;  // Toggle newsletter
  }
});

// Update loop 
function update() {
  let newX = player.x;
  let newY = player.y;
  
  if (keys['w']) newY -= player.speed;
  if (keys['s']) newY += player.speed;
  if (keys['a']) newX -= player.speed;
  if (keys['d']) newX += player.speed;
  
  if (!collides(newX, player.y)) player.x = newX;
  if (!collides(player.x, newY)) player.y = newY;
  
  player.x = Math.max(0, Math.min(canvas.width - player.w, player.x));
  player.y = Math.max(0, Math.min(canvas.height - player.h, player.y));
  
  coords.textContent = `X: ${Math.round(player.x)}, Y: ${Math.round(player.y)}`;
  checkCheckpoint();
}

// Draw 
function draw() {
  ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);
  ctx.drawImage(char, player.x, player.y, player.w, player.h);

  // Show prompt when near checkpoint
if (nearCheckpoint) {
  ctx.fillStyle = 'rgba(0,0,0,0.7)';
  ctx.fillRect(checkpoint.x, checkpoint.y - 70, 250, 60);
  ctx.fillStyle = 'white';
  ctx.font = '16px Arial';
  ctx.fillText('Press C to enter Classroom 1', checkpoint.x + 10, checkpoint.y - 45);
  ctx.fillText('Press M to enter MKS', checkpoint.x + 10, checkpoint.y - 25);
}

  // Show newsletter prompt when near
  if (nearNewsletter) {
    ctx.fillStyle = 'rgba(0,0,0,0.7)';
    ctx.fillRect(player.x, player.y - 30, 260, 25);
    ctx.fillStyle = 'white';
    ctx.font = '14px Arial';
    ctx.fillText('Press E to read the newsletter', player.x + 10, player.y - 12);
  }

  // Draw newsletter modal if open
  if (newsletterOpen) {
    ctx.fillStyle = 'rgba(0,0,0,0.85)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Draw preloaded newsletter image if available
    if (newsletterImg.width > 0) {
      const maxW = canvas.width * 0.8;
      const maxH = canvas.height * 0.8;
      let w = newsletterImg.width;
      let h = newsletterImg.height;
      
      if (w > maxW) {
        h = (h * maxW) / w;
        w = maxW;
      }
      if (h > maxH) {
        w = (w * maxH) / h;
        h = maxH;
      }
      
      const x = (canvas.width - w) / 2;
      const y = (canvas.height - h) / 2;
      ctx.drawImage(newsletterImg, x, y, w, h);
    }

    ctx.fillStyle = 'white';
    ctx.font = '14px Arial';
    ctx.fillText('Press E to close', 20, 40);
  }
}

// Main loop
function loop() {
  update();
  draw();
  requestAnimationFrame(loop);
}
</script>
</body>
</html>
